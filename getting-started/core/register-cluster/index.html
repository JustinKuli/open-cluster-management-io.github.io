<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="shortcut icon" type="image/svg" href="/OCM-White_MainGradient.svg">
    <title>Open Cluster Management</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
    
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/contentpage.css"/>
</head>
<body>
    <div class="wrapper">
<nav id="sidebar">
    <div class="sidebar-header">
        <a class="navlink" href="/">
        <img src="/OCM-White_MainGradient.svg" alt="" width="50" height="70" class="d-inline-block align-text-top">
        <h4>Open Cluster Management</h4>
        </a>
    </div>
    <ul class="list-unstyled components">
        <p>Navigation</p>
        <li>
            <a class="navlink" href="#homeSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Concepts</a>
            <ul class="collapse list-unstyled" id="homeSubmenu">
                <li>
                    <a class="navlink" id="architecture" href="/concepts/architecture">Architecture</a>
                </li>
                <li>
                    <a class="navlink" id="managedcluster" href="/concepts/managedcluster">ManagedCluster</a>
                </li>
                <li>
                    <a class="navlink" id="manifestwork" href="/concepts/manifestwork">ManifestWork</a>
                </li>
                <li>
                    <a class="navlink" id="placement" href="/concepts/placement">Placement</a>
                </li>
                <li>
                    <a class="navlink" id="addon" href="/concepts/addon">Add-ons</a>
                </li>
            </ul>
        </li>
        <li>
            <a class="navlink" href="#pageSubmenu" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Getting Started</a>
            <ul class="collapse  list-unstyled" id="pageSubmenu">

                <li>
                    <a class="navlink" id="quick-start" href="/getting-started/quick-start">Quick Start</a>
                </li>

                <li>
                    
                    <a class="navlink"  id="core" href="/getting-started/core"  >Core Components</a>
                    <ul class="collapse list-unstyled" id="pageSubsubmenu">
                        <li>
                            <a class="navlink" id="cluster-manager" href="/getting-started/core/cluster-manager">Cluster Manager</a>
                        </li>
                        <li>
                            <a class="navlink" id="register-cluster" href="/getting-started/core/register-cluster">Klusterlet Agent</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a class="navlink"  id="integration" href="/getting-started/integration"  >Add-ons and Integrations</a>
                    
                    <ul class="collapse  list-unstyled" id="pageSubsubmenu2">
                        <li>
                            <a class="navlink" id="app-lifecycle" href="/getting-started/integration/app-lifecycle">Application lifecycle management</a>
                        </li>
                        <li>
                            <a class="navlink" id="policy-framework" href="/getting-started/integration/policy-framework">Policy framework</a>
                        </li>
                        <li>
                            <a class="navlink" id="policy-controllers" href="/getting-started/integration/policy-controllers">Policy controllers</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
        <li>
            <a class="navlink" href="#pageSubmenu3" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Scenarios</a>
            <ul class="collapse  list-unstyled" id="pageSubmenu3">
                <li>
                    <a class="navlink" id="releases" href="/scenarios/deploy-kubernetes-resources">Deploy Kubernetes Resources</a>
                </li>
            </ul>
        </li>
        <li>
            <a class="navlink" href="#pageSubmenu2" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle">Community</a>
            <ul class="collapse  list-unstyled" id="pageSubmenu2">
                <li>
                    <a class="navlink" id="releases" href="/community/releases">Releases</a>
                </li>
                <li >
                    <a class="navlink" id="roadmap" href="/community/roadmap">Roadmap</a>
                </li>
                <li>
                    <a class="navlink" id="resource" href="/community/resource">Resources</a>
                </li>
            </ul>
        </li>
        <li>
            <a class="navlink" id="contribute" href="/contribute/contribute">Contribute</a>
        </li>

        <li>
            <a class="navlink" id="blog" href="/blog/blog">Blog</a>
        </li>
    </ul>
    <ul class="list-unstyled CTAs">
        @ Open Cluster Management Authors
    </ul>
</nav>

<div id="content">
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <button type="button" id="sidebarCollapse" class="btn btn-info">
                <i class="fas fa-align-left"></i>
                <span>Toggle Sidebar</span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="nav navbar-nav ml-auto">
                </ul>
            </div>
        </div>
    </nav>
    <h1>Klusterlet agent</h1>
    <p>After the cluster manager is installed on the hub cluster, you need to install the klusterlet agent on another cluster so that it can be registered and managed by the hub cluster.</p>
<!-- spellchecker-disable -->



  <div class="gdoc-toc gdoc-toc__level--3"><nav id="TableOfContents"><ul>
        <li><a href="#prerequisite">Prerequisite</a></li>
        <li><a href="#install-from-source">Install from source</a></li>
        <li><a href="#install-community-operator-from-operatorhubio">Install community operator from OperatorHub.io</a></li>
        <li><a href="#what-is-next">What is next</a></li>
        <li><a href="#troubleshooting">Troubleshooting</a></li>
      </ul></nav><hr></div>


<!-- spellchecker-enable -->
<h2 id="prerequisite">Prerequisite</h2>
<p>Ensure <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl">kubectl</a> and <a href="https://kubernetes-sigs.github.io/kustomize/installation">kustomize</a> are installed.</p>
<p>Ensure <a href="https://golang.org/doc/install">golang</a> is installed, if you are planning to install from the source.</p>
<p>Ensure the open-cluster-management cluster manager is installed on the hub cluster. See <a href="../cluster-manager">Cluster manager</a> for more information.</p>
<p>Prepare another Kubernetes cluster to function as the managed cluster. For example, use <a href="https://kind.sigs.k8s.io/docs/user/quick-start">kind</a> to create another cluster as described in the following instructions. To use <code>kind</code>, you will need <a href="https://docs.docker.com/get-started">docker</a> installed and running.</p>
<p>Set the following environment variables that will be used throughout to simplify the instructions:</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="nb">export</span> <span class="nv">MANAGED_CLUSTER_NAME</span><span class="o">=</span>&lt;your managed cluster name&gt;     <span class="c1"># export MANAGED_CLUSTER_NAME=cluster1</span>
<span class="nb">export</span> <span class="nv">CTX_MANAGED_CLUSTER</span><span class="o">=</span>&lt;your managed cluster context&gt;   <span class="c1"># export CTX_MANAGED_CLUSTER=kind-cluster1</span>
</code></pre></div><p>Then create the managed cluster with <code>kind</code>, run:</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="c1"># kind delete cluster --name ${MANAGED_CLUSTER_NAME} # if the kind cluster is previously created and can be safely deleted</span>
kind create cluster --name <span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span>
</code></pre></div><p>If you are using OKD, OpenShift, you will need to prepare a kubeconfig with <code>certificate-authority-data</code>, <code>client-certificate-data</code> and <code>client-key-data</code>. By default, it&rsquo;s located in <code>auth/kubeconfig</code> under your installation folder.</p>
<h2 id="install-from-source">Install from source</h2>
<p>If you have not already done so, clone the <code>registration-operator</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">git clone https://github.com/open-cluster-management-io/registration-operator
</code></pre></div><p>Ensure the <code>kubectl</code> context is set to point to the managed cluster:</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">kubectl config use-context <span class="si">${</span><span class="nv">CTX_MANAGED_CLUSTER</span><span class="si">}</span>
</code></pre></div><p>Deploy agent on a managed <code>kind</code> cluster.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell"><span class="nb">cd</span> registration-operator
make deploy-spoke <span class="c1"># make deploy-spoke GO_REQUIRED_MIN_VERSION:= # if you see warnings regarding go version</span>
</code></pre></div><h2 id="install-community-operator-from-operatorhubio">Install community operator from OperatorHub.io</h2>
<p>If you are using OKD, OpenShift, or have <code>OLM</code> installed in your cluster, you can install the klusterlet agent community operator with a released version from <a href="https://operatorhub.io/operator/klusterlet">OperatorHub.io</a>.</p>
<h2 id="what-is-next">What is next</h2>
<p>After a successful deployment, a <code>certificatesigningrequest</code> and a <code>managedcluster</code> will be created on the hub cluster.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ kubectl get csr --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span>
NAME                              AGE   REQUESTOR                       CONDITION
<span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span>-&lt;suffix&gt;   41s   kubernetes-admin                Pending
csr-&lt;suffix&gt;                      76m   system:node:hub-control-plane   Approved,Issued
$ kubectl get managedcluster --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span>
NAME                    HUB ACCEPTED   MANAGED CLUSTER URLS   JOINED   AVAILABLE   AGE
<span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span>  <span class="nb">false</span>          https://localhost                           57s
</code></pre></div><p>Next approve the certificate and set managecluster to be accepted by the hub with following commands:</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">kubectl certificate approve <span class="o">{</span>csr name<span class="o">}</span> --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span>
kubectl patch managedcluster <span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span> -p<span class="o">=</span><span class="s1">&#39;{&#34;spec&#34;:{&#34;hubAcceptsClient&#34;:true}}&#39;</span> --type<span class="o">=</span>merge --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span>
</code></pre></div><p>Run <code>kubectl get managedcluster --context ${CTX_HUB_CLUSTER}</code> again on the hub cluster. You should be able to see that the managed cluster is registered now.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">NAME                     HUB ACCEPTED   MANAGED CLUSTER URLS   JOINED   AVAILABLE   AGE
<span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span>   <span class="nb">true</span>           https://localhost      True     True        7m58s
</code></pre></div><p>If the managed cluster status is not true, refer to <a href="#troubleshooting">Troubleshooting</a> to debug on your cluster.</p>
<p>After the managed cluster is registered, test that you can deploy a pod to the managed cluster from the hub cluster. Create a <code>manifest-work.yaml</code> as shown in this example:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>work.open-cluster-management.io/v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ManifestWork<span class="w">
</span><span class="w"></span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>mw<span class="m">-01</span><span class="w">
</span><span class="w">  </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>${MANAGED_CLUSTER_NAME}<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">workload</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">manifests</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w">        </span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>Pod<span class="w">
</span><span class="w">        </span><span class="k">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>hello<span class="w">
</span><span class="w">          </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">        </span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">containers</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="k">name</span><span class="p">:</span><span class="w"> </span>hello<span class="w">
</span><span class="w">              </span><span class="k">image</span><span class="p">:</span><span class="w"> </span>busybox<span class="w">
</span><span class="w">              </span><span class="k">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;echo &#34;Hello, Kubernetes!&#34; &amp;&amp; sleep 3600&#39;</span><span class="p">]</span><span class="w">
</span><span class="w">          </span><span class="k">restartPolicy</span><span class="p">:</span><span class="w"> </span>OnFailure<span class="w">
</span></code></pre></div><p>Apply the yaml file to the hub cluster.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">kubectl apply -f manifest-work.yaml --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span>
</code></pre></div><p>Verify that the <code>manifestwork</code> resource was applied to the hub.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">kubectl -n <span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span> get manifestwork/mw-01 --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span> -o yaml
</code></pre></div><p>Check on the managed cluster and see the <em>hello</em> Pod has been deployed from the hub cluster.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ kubectl -n default get pod --context <span class="si">${</span><span class="nv">CTX_MANAGED_CLUSTER</span><span class="si">}</span>
NAME    READY   STATUS    RESTARTS   AGE
hello   1/1     Running   <span class="m">0</span>          108s
</code></pre></div><h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li>
<p>The managed cluster status is not true.</p>
<p>For example, the result below is shown when checking managedcluster.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">$ kubectl get managedcluster --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span>
NAME                   HUB ACCEPTED   MANAGED CLUSTER URLS   JOINED   AVAILABLE   AGE
<span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span> <span class="nb">true</span>           https://localhost               Unknown     46m
</code></pre></div><p>There are many reasons for this problem. You can use the commands below to get more debug info. If the provided info doesn&rsquo;t help, please log an issue to us.</p>
<p>On the hub cluster, check the managedcluster status.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">kubectl get managedcluster <span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span> --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span> -o yaml
</code></pre></div><p>On the hub cluster, check the lease status.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">kubectl get lease -n <span class="si">${</span><span class="nv">MANAGED_CLUSTER_NAME</span><span class="si">}</span> --context <span class="si">${</span><span class="nv">CTX_HUB_CLUSTER</span><span class="si">}</span>
</code></pre></div><p>On the managed cluster, check the klusterlet status.</p>
<div class="highlight"><pre class="chroma"><code class="language-Shell" data-lang="Shell">kubectl get klusterlet -o yaml --context <span class="si">${</span><span class="nv">CTX_MANAGED_CLUSTER</span><span class="si">}</span>
</code></pre></div></li>
</ul>


    <script type="text/javascript" src="/clipboard-copy.js"></script>
</div> 
</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        arr = window.location.pathname.split("/");
        var linkname= arr[arr.length-2];
        console.log(linkname);
        $('#'+linkname).css({"background":"#fff", "color": "#7386D5"});
        var pathname = window.location.pathname.split("/")[1]; 
        console.log(pathname);
        if (pathname == "concepts"){
            $('#homeSubmenu').addClass('show');
        }
        if (pathname == "community"){
            $('#pageSubmenu2').addClass('show');
        }
        if (pathname == "getting-started"){
            $('#pageSubmenu').addClass('show');
            $('#pageSubsubmenu').addClass('show');
            $('#pageSubsubmenu2').addClass('show');   
        }
        if (pathname == "scenarios"){
            $('#pageSubmenu3').addClass('show');
        }

        $("#sidebar").mCustomScrollbar({
            theme: "minimal"
        });
        $('#sidebarCollapse').on('click', function () {
            console.log("2");
            $('#sidebar, #content').toggleClass('active');
            $('.collapse.in').toggleClass('in');
            $('a[aria-expanded=true]').attr('aria-expanded', 'false');
        });
    });
</script>
</body>
</html>
